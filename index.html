import React, { useState, useEffect, useRef } from 'react';
import { Search, MapPin, ExternalLink, Plus, Users } from 'lucide-react';

// 都道府県リスト
const PREFECTURES = [
  '北海道', '青森県', '岩手県', '宮城県', '秋田県', '山形県', '福島県',
  '茨城県', '栃木県', '群馬県', '埼玉県', '千葉県', '東京都', '神奈川県',
  '新潟県', '富山県', '石川県', '福井県', '山梨県', '長野県', '岐阜県',
  '静岡県', '愛知県', '三重県', '滋賀県', '京都府', '大阪府', '兵庫県',
  '奈良県', '和歌山県', '鳥取県', '島根県', '岡山県', '広島県', '山口県',
  '徳島県', '香川県', '愛媛県', '高知県', '福岡県', '佐賀県', '長崎県',
  '熊本県', '大分県', '宮崎県', '鹿児島県', '沖縄県'
];

// 花火エフェクトコンポーネント
const FireworksEffect = ({ isActive, onComplete }) => {
  const canvasRef = useRef(null);
  const animationRef = useRef(null);
  const particlesRef = useRef([]);
  const rocketsRef = useRef([]);
  const startTimeRef = useRef(null);
  const FIREWORKS_DURATION = 10000; // 10秒間

  // パステル調の色パレット
  const pastelColors = [
    '#FFB6C1', '#FFC0CB', '#E6E6FA', '#DDA0DD', '#FFEFD5',
    '#F0E68C', '#98FB98', '#AFEEEE', '#F0FFFF', '#FFE4E1',
    '#E0BBE4', '#957DAD', '#D291BC', '#FEC8D8', '#FFDFD3',
    '#C7CEEA', '#A8E6CF', '#DCEDC1', '#FFD3A5', '#FD9853'
  ];

  // 音響効果の生成（改良版）
  const playLaunchSound = () => {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      const filter = audioContext.createBiquadFilter();
      
      oscillator.connect(filter);
      filter.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // フィルターの設定
      filter.type = 'lowpass';
      filter.frequency.setValueAtTime(1000, audioContext.currentTime);
      
      // 打ち上げ音（シューッという音を長めに）
      oscillator.frequency.setValueAtTime(150, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(800, audioContext.currentTime + 1.2);
      
      gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.15, audioContext.currentTime + 0.3);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1.2);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 1.2);
    } catch (error) {
      console.log('音響再生エラー:', error);
    }
  };

  const playBurstSound = () => {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      const noiseBuffer = audioContext.createBuffer(1, audioContext.sampleRate * 0.3, audioContext.sampleRate);
      const noiseSource = audioContext.createBufferSource();
      const noiseGain = audioContext.createGain();
      const filter = audioContext.createBiquadFilter();
      
      // ホワイトノイズの生成（爆発音用）
      const output = noiseBuffer.getChannelData(0);
      for (let i = 0; i < noiseBuffer.length; i++) {
        output[i] = Math.random() * 2 - 1;
      }
      
      noiseSource.buffer = noiseBuffer;
      noiseSource.connect(filter);
      filter.connect(noiseGain);
      noiseGain.connect(audioContext.destination);
      
      // フィルター設定
      filter.type = 'bandpass';
      filter.frequency.setValueAtTime(2000, audioContext.currentTime);
      filter.Q.setValueAtTime(1, audioContext.currentTime);
      
      // 開花音（パンッという音をより迫力的に）
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(1200, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(300, audioContext.currentTime + 0.4);
      
      gainNode.gain.setValueAtTime(0.25, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
      
      noiseGain.gain.setValueAtTime(0.15, audioContext.currentTime);
      noiseGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.4);
      noiseSource.start(audioContext.currentTime);
      noiseSource.stop(audioContext.currentTime + 0.3);
    } catch (error) {
      console.log('音響再生エラー:', error);
    }
  };

  // ロケット（打ち上げ段階）クラス
  class Rocket {
    constructor(x, y, targetY, color, pattern) {
      this.x = x;
      this.y = y;
      this.targetY = targetY;
      this.color = color;
      this.pattern = pattern;
      this.velocity = 0;
      this.acceleration = -0.5;
      this.trail = [];
      this.hasExploded = false;
    }

    update() {
      this.velocity += this.acceleration;
      this.y += this.velocity;
      
      // 軌跡を記録
      this.trail.push({ x: this.x, y: this.y });
      if (this.trail.length > 20) {
        this.trail.shift();
      }

      // 目標高度に達したら爆発
      if (this.y <= this.targetY && !this.hasExploded) {
        this.explode();
        this.hasExploded = true;
        return false; // ロケットを削除
      }
      
      return true;
    }

    draw(ctx) {
      // 軌跡を描画
      for (let i = 0; i < this.trail.length; i++) {
        const point = this.trail[i];
        const alpha = i / this.trail.length;
        const size = alpha * 3;
        
        ctx.globalAlpha = alpha * 0.8;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(point.x, point.y, size, 0, Math.PI * 2);
        ctx.fill();
      }

      // ロケット本体
      ctx.globalAlpha = 1;
      ctx.fillStyle = this.color;
      ctx.beginPath();
      ctx.arc(this.x, this.y, 4, 0, Math.PI * 2);
      ctx.fill();
    }

    explode() {
      playBurstSound();
      
      switch(this.pattern) {
        case 'chrysanthemum':
          this.createChrysanthemum();
          break;
        case 'willow':
          this.createWillow();
          break;
        case 'peony':
          this.createPeony();
          break;
        case 'ring':
          this.createRing();
          break;
        case 'heart':
          this.createHeart();
          break;
        case 'star':
          this.createStar();
          break;
        default:
          this.createChrysanthemum();
      }
    }

    // 菊花火（球状に散らばる）
    createChrysanthemum() {
      const particleCount = 60;
      for (let i = 0; i < particleCount; i++) {
        const angle = (i / particleCount) * Math.PI * 2;
        const speed = Math.random() * 8 + 4;
        particlesRef.current.push(new Particle(
          this.x, this.y, this.color,
          Math.cos(angle) * speed,
          Math.sin(angle) * speed,
          'normal'
        ));
      }
    }

    // 柳花火（垂れ下がる）
    createWillow() {
      const particleCount = 40;
      for (let i = 0; i < particleCount; i++) {
        const angle = Math.random() * Math.PI - Math.PI/2;
        const speed = Math.random() * 6 + 2;
        particlesRef.current.push(new Particle(
          this.x, this.y, this.color,
          Math.cos(angle) * speed,
          Math.sin(angle) * speed,
          'willow'
        ));
      }
    }

    // 牡丹花火（大きく広がる）
    createPeony() {
      const particleCount = 80;
      for (let i = 0; i < particleCount; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 12 + 6;
        particlesRef.current.push(new Particle(
          this.x, this.y, this.color,
          Math.cos(angle) * speed,
          Math.sin(angle) * speed,
          'peony'
        ));
      }
    }

    // リング花火（輪状）
    createRing() {
      const particleCount = 50;
      for (let i = 0; i < particleCount; i++) {
        const angle = (i / particleCount) * Math.PI * 2;
        const speed = 8;
        particlesRef.current.push(new Particle(
          this.x, this.y, this.color,
          Math.cos(angle) * speed,
          Math.sin(angle) * speed,
          'ring'
        ));
      }
    }

    // ハート形花火
    createHeart() {
      const particleCount = 60;
      for (let i = 0; i < particleCount; i++) {
        const t = (i / particleCount) * Math.PI * 2;
        const x = 16 * Math.pow(Math.sin(t), 3);
        const y = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
        const speed = 0.3;
        particlesRef.current.push(new Particle(
          this.x, this.y, this.color,
          x * speed,
          y * speed,
          'heart'
        ));
      }
    }

    // 星形花火
    createStar() {
      const spikes = 5;
      const particleCount = 50;
      for (let i = 0; i < particleCount; i++) {
        const angle = (i / particleCount) * Math.PI * 2;
        const radius = (Math.sin(angle * spikes) > 0) ? 10 : 6;
        const speed = Math.random() * 4 + 2;
        particlesRef.current.push(new Particle(
          this.x, this.y, this.color,
          Math.cos(angle) * radius * speed * 0.8,
          Math.sin(angle) * radius * speed * 0.8,
          'star'
        ));
      }
    }
  }

  // 花火の粒子クラス（改良版）
  class Particle {
    constructor(x, y, color, vx, vy, type) {
      this.x = x;
      this.y = y;
      this.startX = x;
      this.startY = y;
      this.color = color;
      this.velocity = { x: vx, y: vy };
      this.size = Math.random() * 6 + 2;
      this.life = 1;
      this.decay = Math.random() * 0.015 + 0.008;
      this.gravity = type === 'willow' ? 0.2 : 0.1;
      this.trail = [];
      this.type = type;
      this.sparkle = Math.random() > 0.7;
    }

    update() {
      this.velocity.y += this.gravity;
      this.x += this.velocity.x;
      this.y += this.velocity.y;
      this.life -= this.decay;
      
      // 特殊効果
      if (this.type === 'willow') {
        this.velocity.x *= 0.98; // 抵抗
      } else if (this.type === 'ring') {
        this.velocity.x *= 0.99;
        this.velocity.y *= 0.99;
      }
      
      // 軌跡を記録
      this.trail.push({ x: this.x, y: this.y, life: this.life });
      const maxTrail = this.type === 'willow' ? 15 : 8;
      if (this.trail.length > maxTrail) {
        this.trail.shift();
      }
    }

    draw(ctx) {
      // 軌跡を描画
      for (let i = 0; i < this.trail.length; i++) {
        const point = this.trail[i];
        const alpha = (point.life * (i / this.trail.length)) * 0.6;
        const size = this.size * (i / this.trail.length) * 0.5;
        
        ctx.globalAlpha = alpha;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(point.x, point.y, size, 0, Math.PI * 2);
        ctx.fill();
      }

      // メインの粒子を描画
      ctx.globalAlpha = this.life;
      ctx.fillStyle = this.color;
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
      ctx.fill();
      
      // きらめき効果
      if (this.sparkle && this.life > 0.5) {
        ctx.shadowBlur = 30;
        ctx.shadowColor = this.color;
        ctx.fill();
        ctx.shadowBlur = 0;
        
        // 十字の光
        ctx.strokeStyle = this.color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(this.x - this.size*2, this.y);
        ctx.lineTo(this.x + this.size*2, this.y);
        ctx.moveTo(this.x, this.y - this.size*2);
        ctx.lineTo(this.x, this.y + this.size*2);
        ctx.stroke();
      }
    }
  }

  // 花火パターンの配列
  const fireworkPatterns = ['chrysanthemum', 'willow', 'peony', 'ring', 'heart', 'star'];

  // 花火を生成（遅延機能付き）
  const createFirework = (x, y, delay = 0) => {
    const color = pastelColors[Math.floor(Math.random() * pastelColors.length)];
    const pattern = fireworkPatterns[Math.floor(Math.random() * fireworkPatterns.length)];
    const targetY = Math.random() * y * 0.4 + y * 0.1;
    
    rocketsRef.current.push(new Rocket(x, y, targetY, color, pattern, delay));
  };

  // アニメーションループ
  const animate = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const currentTime = Date.now();
    const elapsed = currentTime - startTimeRef.current;
    
    // 10秒経過したら終了
    if (elapsed > FIREWORKS_DURATION) {
      // 残りの粒子とロケットが全て消えるまで待つ
      if (particlesRef.current.length === 0 && rocketsRef.current.length === 0) {
        if (onComplete) {
          onComplete();
        }
        return;
      }
    }
    
    // ロケットを更新・描画
    rocketsRef.current = rocketsRef.current.filter(rocket => {
      rocket.draw(ctx);
      return rocket.update();
    });
    
    // 粒子を更新・描画
    particlesRef.current = particlesRef.current.filter(particle => {
      particle.update();
      particle.draw(ctx);
      return particle.life > 0;
    });

    // 10秒間は定期的に新しい花火を生成
    if (elapsed < FIREWORKS_DURATION) {
      // より頻繁に花火を生成（連続的な打ち上げ）
      if (Math.random() < 0.15) {
        const x = Math.random() * canvas.width;
        const y = canvas.height;
        const delay = Math.random() * 500; // 0-500msの遅延
        createFirework(x, y, delay);
      }
    }

    animationRef.current = requestAnimationFrame(animate);
  };

  useEffect(() => {
    if (isActive) {
      const canvas = canvasRef.current;
      if (canvas) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        startTimeRef.current = Date.now(); // 開始時間を記録
        
        // 初期花火を時間差で連続発生（10秒間分）
        for (let i = 0; i < 20; i++) {
          setTimeout(() => {
            const x = Math.random() * canvas.width;
            const y = canvas.height;
            const delay = Math.random() * 800; // ランダムな遅延
            createFirework(x, y, delay);
          }, i * 400 + Math.random() * 300); // 400ms間隔＋ランダム要素
        }
        
        animate();
      }
    }

    return () => {
      if (animationRef.current) {
        cancelAnimationFrame(animationRef.current);
      }
      particlesRef.current = [];
      rocketsRef.current = [];
    };
  }, [isActive]);

  if (!isActive) return null;

  return (
    <canvas
      ref={canvasRef}
      className="fixed inset-0 pointer-events-none z-50"
      style={{ background: 'rgba(0, 0, 0, 0.1)' }}
    />
  );
};

// 県選択ドロップダウンコンポーネント
const PrefectureSelector = ({ selectedPrefecture, onPrefectureChange, onFireworks }) => {
  const handleChange = (value) => {
    if (value && value !== selectedPrefecture) {
      onFireworks(); // 県変更時に花火エフェクト
    }
    onPrefectureChange(value);
  };
  return (
    <div className="mb-6">
      <label htmlFor="prefecture" className="block text-sm font-medium text-gray-700 mb-2">
        <MapPin className="inline w-4 h-4 mr-1" />
        都道府県を選択
      </label>
      <select
        id="prefecture"
        value={selectedPrefecture}
        onChange={(e) => handleChange(e.target.value)}
        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
      >
        <option value="">都道府県を選択してください</option>
        {PREFECTURES.map((prefecture) => (
          <option key={prefecture} value={prefecture}>
            {prefecture}
          </option>
        ))}
      </select>
    </div>
  );
};

// 博物館登録フォームコンポーネント
const MuseumForm = ({ selectedPrefecture, onSubmit, onFireworks }) => {
  const [formData, setFormData] = useState({
    name: '',
    homepage: '',
    description: '',
    registeredBy: ''
  });
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };

  const handleSubmit = async () => {
    if (!selectedPrefecture) {
      alert('都道府県を選択してください');
      return;
    }
    
    if (!formData.name || !formData.registeredBy) {
      alert('博物館名と登録者名は必須項目です');
      return;
    }

    setIsSubmitting(true);
    
    try {
      // 花火エフェクトを開始
      onFireworks();
      
      // ここでFirestoreへの保存処理を呼び出す（後で実装）
      await onSubmit({
        ...formData,
        prefecture: selectedPrefecture,
        createdAt: new Date()
      });
      
      // フォームをリセット
      setFormData({
        name: '',
        homepage: '',
        description: '',
        registeredBy: ''
      });
      
      alert('🎆 花火博物館情報を登録しました！');
    } catch (error) {
      alert('登録に失敗しました。もう一度お試しください。');
      console.error('登録エラー:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="bg-white rounded-lg shadow-md p-6 mb-8 border-l-4 border-purple-500">
      <h2 className="text-xl font-bold text-purple-800 mb-4 flex items-center">
        <Plus className="w-5 h-5 mr-2" />
        花火展示のある博物館を登録
      </h2>
      
      {!selectedPrefecture && (
        <p className="text-orange-600 bg-orange-50 p-3 rounded-lg mb-4 border border-orange-200">
          🎆 花火博物館を登録するには、まず都道府県を選択してください。
        </p>
      )}
      
      <div className="space-y-4">
        <div>
          <label htmlFor="name" className="block text-sm font-medium text-purple-700 mb-1">
            博物館名・施設名 <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="name"
            name="name"
            value={formData.name}
            onChange={handleChange}
            placeholder="例：○○花火博物館、○○郷土資料館"
            className="w-full p-3 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            disabled={!selectedPrefecture || isSubmitting}
            required
          />
        </div>

        <div>
          <label htmlFor="homepage" className="block text-sm font-medium text-purple-700 mb-1">
            ホームページURL
          </label>
          <input
            type="url"
            id="homepage"
            name="homepage"
            value={formData.homepage}
            onChange={handleChange}
            placeholder="https://example.com"
            className="w-full p-3 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            disabled={!selectedPrefecture || isSubmitting}
          />
        </div>

        <div>
          <label htmlFor="description" className="block text-sm font-medium text-purple-700 mb-1">
            花火展示の内容・特徴
          </label>
          <textarea
            id="description"
            name="description"
            value={formData.description}
            onChange={handleChange}
            placeholder="どんな花火の展示がありますか？（例：江戸時代の花火資料、花火師の道具、地域の花火大会の歴史など）"
            rows="4"
            className="w-full p-3 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
            disabled={!selectedPrefecture || isSubmitting}
          />
        </div>

        <div>
          <label htmlFor="registeredBy" className="block text-sm font-medium text-purple-700 mb-1">
            登録者名 <span className="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="registeredBy"
            name="registeredBy"
            value={formData.registeredBy}
            onChange={handleChange}
            placeholder="あなたのお名前"
            className="w-full p-3 border border-purple-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            disabled={!selectedPrefecture || isSubmitting}
            required
          />
        </div>

        <button
          onClick={handleSubmit}
          disabled={!selectedPrefecture || isSubmitting}
          className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 px-4 rounded-lg hover:from-purple-700 hover:to-pink-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors duration-200 flex items-center justify-center"
        >
          {isSubmitting ? (
            <>処理中...</>
          ) : (
            <>
              <Plus className="w-4 h-4 mr-2" />
              🎆 花火博物館を登録する
            </>
          )}
        </button>
      </div>
    </div>
  );
};

// 個別博物館カードコンポーネント
const MuseumCard = ({ museum }) => {
  return (
    <div className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-200 border-l-4 border-purple-400">
      <div className="flex items-start justify-between mb-3">
        <h3 className="text-lg font-semibold text-purple-800 flex-1">
          {museum.homepage ? (
            <a
              href={museum.homepage}
              target="_blank"
              rel="noopener noreferrer"
              className="text-purple-600 hover:text-purple-800 hover:underline flex items-center"
            >
              🎆 {museum.name}
              <ExternalLink className="w-4 h-4 ml-1 flex-shrink-0" />
            </a>
          ) : (
            `🎆 ${museum.name}`
          )}
        </h3>
      </div>
      
      {museum.description && (
        <p className="text-gray-600 mb-3 leading-relaxed">
          {museum.description}
        </p>
      )}
      
      <div className="flex items-center justify-between text-sm text-purple-600">
        <span className="flex items-center">
          <Users className="w-4 h-4 mr-1" />
          登録者: {museum.registeredBy}
        </span>
        <span>
          {museum.createdAt?.toDate().toLocaleDateString('ja-JP')}
        </span>
      </div>
    </div>
  );
};

// 博物館一覧表示コンポーネント
const MuseumList = ({ museums, selectedPrefecture }) => {
  if (!selectedPrefecture) {
    return (
      <div className="text-center py-12">
        <Search className="w-16 h-16 text-gray-400 mx-auto mb-4" />
        <p className="text-gray-500 text-lg">都道府県を選択して博物館を検索してください</p>
      </div>
    );
  }

  if (museums.length === 0) {
    return (
      <div className="text-center py-12">
        <div className="text-gray-400 mb-4">
          <MapPin className="w-16 h-16 mx-auto" />
        </div>
        <p className="text-gray-500 text-lg mb-2">
          {selectedPrefecture}の博物館はまだ登録されていません
        </p>
        <p className="text-gray-400">
          最初の博物館を登録してみませんか？
        </p>
      </div>
    );
  }

  return (
    <div>
      <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center">
        <MapPin className="w-5 h-5 mr-2" />
        {selectedPrefecture}の博物館 ({museums.length}件)
      </h2>
      <div className="space-y-4">
        {museums.map((museum, index) => (
          <MuseumCard key={index} museum={museum} />
        ))}
      </div>
    </div>
  );
};

// メインアプリケーションコンポーネント
const App = () => {
  const [selectedPrefecture, setSelectedPrefecture] = useState('');
  const [museums, setMuseums] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showFireworks, setShowFireworks] = useState(false);

  // 花火エフェクトを開始する関数
  const triggerFireworks = () => {
    setShowFireworks(true);
  };

  // 花火エフェクト完了時のコールバック
  const handleFireworksComplete = () => {
    setShowFireworks(false);
  };

  // 県が変更された時の処理
  useEffect(() => {
    if (selectedPrefecture) {
      loadMuseums(selectedPrefecture);
    } else {
      setMuseums([]);
    }
  }, [selectedPrefecture]);

  // 博物館データの読み込み（後でFirestoreから取得するように変更）
  const loadMuseums = async (prefecture) => {
    setLoading(true);
    try {
      // 現在はダミーデータを表示（後でFirestoreから取得）
      const dummyData = [
        {
          name: `${prefecture}花火資料館`,
          homepage: 'https://example.com',
          description: '江戸時代から現代までの花火の歴史を紹介する専門資料館。花火師の道具、古い花火玉の展示、地域の花火大会の貴重な記録などを展示しています。',
          registeredBy: '花火愛好家',
          createdAt: { toDate: () => new Date() }
        },
        {
          name: `${prefecture}郷土博物館`,
          homepage: 'https://example.com',
          description: '郷土の歴史展示の一角で、地域の伝統的な花火大会の歴史や花火作りの技術を紹介。夏季特別展では花火をテーマにした企画展も開催。',
          registeredBy: '地域研究者',
          createdAt: { toDate: () => new Date() }
        }
      ];
      
      // 実際のFirestore処理では以下のようになります
      // const museumsSnapshot = await getDocs(query(collection(db, 'museums'), where('prefecture', '==', prefecture)));
      // const museumsData = museumsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // setMuseums(museumsData);
      
      setMuseums(prefecture === '東京都' || prefecture === '秋田県' ? dummyData : []); // デモ用
    } catch (error) {
      console.error('博物館データの取得に失敗:', error);
      setMuseums([]);
    } finally {
      setLoading(false);
    }
  };

  // 博物館登録処理（後でFirestoreに保存するように変更）
  const handleMuseumSubmit = async (museumData) => {
    // 現在はローカルステートに追加（後でFirestoreに保存）
    console.log('登録データ:', museumData);
    
    // 実際のFirestore処理では以下のようになります
    // await addDoc(collection(db, 'museums'), museumData);
    
    // ローカルで即座に反映（デモ用）
    setMuseums(prev => [...prev, {
      ...museumData,
      createdAt: { toDate: () => new Date() }
    }]);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 relative">
      {/* 花火エフェクト */}
      <FireworksEffect 
        isActive={showFireworks} 
        onComplete={handleFireworksComplete}
      />
      {/* ヘッダー */}
      <header className="bg-gradient-to-r from-indigo-900 via-purple-900 to-pink-900 shadow-lg border-b relative z-10">
        <div className="max-w-4xl mx-auto px-4 py-6">
          <h1 
            className="text-2xl md:text-3xl font-bold text-white text-center cursor-pointer hover:text-yellow-300 transition-colors"
            onClick={triggerFireworks}
          >
            🎆 全国花火博物館データベース ✨
          </h1>
          <p className="text-purple-100 text-center mt-2">
            花火の歴史・技術・文化を学べる博物館情報サイト（タイトルクリックで花火！）
          </p>
        </div>
      </header>

      {/* メインコンテンツ */}
      <main className="max-w-4xl mx-auto px-4 py-8 relative z-10">
        {/* 県選択ドロップダウン */}
        <PrefectureSelector
          selectedPrefecture={selectedPrefecture}
          onPrefectureChange={setSelectedPrefecture}
          onFireworks={triggerFireworks}
        />

        {/* 博物館登録フォーム */}
        <MuseumForm
          selectedPrefecture={selectedPrefecture}
          onSubmit={handleMuseumSubmit}
          onFireworks={triggerFireworks}
        />

        {/* 博物館一覧 */}
        {loading ? (
          <div className="text-center py-8">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p className="text-gray-500 mt-4">読み込み中...</p>
          </div>
        ) : (
          <MuseumList
            museums={museums}
            selectedPrefecture={selectedPrefecture}
          />
        )}
      </main>

      {/* フッター */}
      <footer className="bg-gradient-to-r from-indigo-900 via-purple-900 to-pink-900 border-t mt-16 relative z-10">
        <div className="max-w-4xl mx-auto px-4 py-6 text-center text-purple-100">
          <p>&copy; 2025 全国花火博物館データベース 🎆</p>
          <p className="text-sm mt-1 text-purple-200">花火の文化と歴史を次世代に継承する</p>
          <button
            onClick={triggerFireworks}
            className="mt-3 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"
          >
            🎆 花火ショーを見る
          </button>
        </div>
      </footer>
    </div>
  );
};

export default App;
